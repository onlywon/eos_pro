<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ event.title }} - Workroom</title>
    <style>
        /* [ê¸°ë³¸ í…Œë§ˆ ìœ ì§€] */
        body { background-color: #1e1e1e; color: #e0e0e0; font-family: 'Suit', sans-serif; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        
        /* [í—¤ë”] */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 20px; margin-bottom: 30px; }
        .event-title { font-size: 32px; font-weight: bold; color: #00ff00; margin: 0; display: flex; align-items: center; gap: 10px; }
        .event-meta { color: #888; font-size: 14px; margin-top: 5px; }
        
        /* [ë±ƒì§€ ìŠ¤íƒ€ì¼] */
        .badge { font-size: 14px; padding: 4px 10px; border-radius: 4px; background: #444; color: #ccc; }
        .badge-status { background: #007acc; color: white; }

        .btn-back { color: #aaa; text-decoration: none; font-size: 14px; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; transition: 0.3s; }
        .btn-back:hover { background: #333; color: white; }

        /* [íƒ­ ë©”ë‰´ - 5ê°œë¡œ í™•ì¥] */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #333; }
        .tab-btn { 
            padding: 12px 20px; background: #2a2a2a; border: none; color: #888; 
            font-size: 15px; font-weight: bold; cursor: pointer; 
            border-radius: 8px 8px 0 0; transition: 0.3s; margin-bottom: -2px;
        }
        .tab-btn:hover { background: #333; color: white; }
        .tab-btn.active { background: #007acc; color: white; border-bottom: 2px solid #007acc; }

        /* [íƒ­ ì»¨í…ì¸ ] */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* [ëŒ€ì‹œë³´ë“œ ê³„ê¸°íŒ ìŠ¤íƒ€ì¼ (ì‹ ê·œ)] */
        .grid-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .dash-card { background: #252526; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333; }
        .dash-label { color: #aaa; font-size: 13px; margin-bottom: 5px; font-weight: bold; }
        .dash-value { font-size: 26px; font-weight: bold; color: white; font-family: 'Consolas', monospace; } /* ìˆ«ì í°íŠ¸ ê°•ì¡° */
        .dash-sub { font-size: 12px; color: #666; margin-top: 5px; }
        
        .progress-bg { width: 100%; background: #444; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #00ff00; width: 0%; transition: width 1s ease-in-out; }

        /* [ë°•ìŠ¤ ìŠ¤íƒ€ì¼] */
        .box { background-color: #252526; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section-title { color: #007acc; font-size: 18px; font-weight: bold; margin-bottom: 15px; border-left: 4px solid #007acc; padding-left: 10px; }
        
        /* [ê·¸ë¦¬ë“œ] */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

        /* [í¼ & ë²„íŠ¼] */
        label { display: block; color: #aaa; font-size: 13px; margin-bottom: 5px; }
        .form-input { background: #333; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .form-input:focus { border-color: #007acc; outline: none; }
        
        .btn-save { background: #007acc; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-save:hover { background: #005a9e; }
        
        .btn-del { background: #ff4b4b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-del:hover { background: #cc0000; }

        /* [í…Œì´ë¸”] */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #444; color: #aaa; background: #2a2a2a; }
        td { padding: 12px; border-bottom: 1px solid #333; }

        /* [í…ìŠ¤íŠ¸ ìœ í‹¸] */
        .text-warn { color: #ff4b4b; } .text-safe { color: #00ff00; } .text-yellow { color: #ffeb3b; }
        
        /* [ì´ë¯¸ì§€] */
        .graph-img { width: 100%; border-radius: 5px; background-color: #fff; margin-bottom: 20px; }
    </style>
    <script>
        function openTab(id, btn) {
            var contents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < contents.length; i++) { contents[i].classList.remove("active"); }
            var btns = document.getElementsByClassName("tab-btn");
            for (var i = 0; i < btns.length; i++) { btns[i].classList.remove("active"); }
            document.getElementById(id).classList.add("active");
            btn.classList.add("active");
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 class="event-title">
                    {{ event.title }} 
                    <span class="badge badge-status" style="margin-left:10px; font-size:16px;">{{ event.get_status_display }}</span>
                </h1>
                <div class="event-meta">
                    ğŸ“… {{ event.date }} | ğŸ¢ {{ event.client_name|default:"í´ë¼ì´ì–¸íŠ¸ ë¯¸ì •" }}
                </div>
            </div>
            <a href="{% url 'index' %}" class="btn-back">â† ëŒ€ì‹œë³´ë“œ</a>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="openTab('tab1', this)">1. í”„ë¡œì íŠ¸ ìƒí™©ì‹¤</button>
            <button class="tab-btn" onclick="openTab('tab2', this)">2. ê³µê°„ ì„¤ê³„</button>
            <button class="tab-btn" onclick="openTab('tab3', this)">3. ìŒí–¥/ì¡°ëª…</button>
            <button class="tab-btn" onclick="openTab('tab4', this)">4. ì¼ì • ê´€ë¦¬</button>
            <button class="tab-btn" onclick="openTab('tab5', this)">5. íì‹œíŠ¸</button>
        </div>

        <div id="tab1" class="tab-content active">
            <div class="grid-dashboard">
                <div class="dash-card">
                    <div class="dash-label">D-Day</div>
                    <div class="dash-value" style="color: {% if d_day < 7 %}#ff4b4b{% else %}white{% endif %};">
                        {% if d_day == 0 %} D-Day {% elif d_day > 0 %} D-{{ d_day }} {% else %} ì¢…ë£Œ {% endif %}
                    </div>
                    <div class="dash-sub">{{ event.date|date:"Y.m.d" }}</div>
                </div>
                
                <div class="dash-card">
                    <div class="dash-label">ì´ ë§¤ì¶œ(ì˜ˆì‚°)</div>
                    <div class="dash-value">â‚© {{ fmt_budget }}</div>
                    <div class="dash-sub">ì˜ˆìƒ ë¹„ìš©: â‚© {{ fmt_cost }}</div>
                </div>

                <div class="dash-card">
                    <div class="dash-label">ì˜ˆìƒ ìˆœì´ìµ (NET)</div>
                    <div class="dash-value" style="color: {% if profit_raw < 0 %}#ff4b4b{% else %}#00ff00{% endif %};">
                        {{ fmt_profit }}
                    </div>
                    <div class="dash-sub">
                        ìˆ˜ìµë¥ : <span style="background: {% if profit_rate < 0 %}#ff4b4b{% else %}#217346{% endif %}; color:white; padding:2px 6px; border-radius:3px;">{{ profit_rate }}%</span>
                    </div>
                </div>

                <div class="dash-card">
                    <div class="dash-label">ì¤€ë¹„ ì§„ì²™ë¥ </div>
                    <div class="dash-value">{{ progress }}%</div>
                    <div class="progress-bg"><div class="progress-fill" style="width: {{ progress }}%;"></div></div>
                </div>
            </div>

            <div class="grid-2">
                <div class="box">
                    <div class="section-title">ğŸ“ ê¸°ë³¸ ì •ë³´ ê´€ë¦¬</div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_overview" value="true">
                        
                        <div class="grid-2">
                            <div><label>í”„ë¡œì íŠ¸ëª…</label>{{ overview_form.title }}</div>
                            <div><label>í´ë¼ì´ì–¸íŠ¸</label>{{ overview_form.client_name }}</div>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div><label>í–‰ì‚¬ì¼</label>{{ overview_form.date }}</div>
                            <div><label>ì§„í–‰ ìƒíƒœ</label>{{ overview_form.status }}</div>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div><label>ì¥ì†Œëª…</label>{{ overview_form.venue_name }}</div>
                            <div><label>ìœ í˜•</label><input type="text" value="{{ event.get_event_type_display }}" class="form-input" disabled style="color:#888;"></div>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div><label>ë§¤ì¶œ (ì´ ì˜ˆì‚°)</label>{{ overview_form.budget }}</div>
                            <div><label>ì˜ˆìƒ ë¹„ìš© (ì§€ì¶œ)</label>{{ overview_form.expected_cost }}</div>
                        </div>
                        
                        <button type="submit" class="btn-save">ìƒí™©íŒ ì—…ë°ì´íŠ¸</button>
                    </form>
                </div>
                
                <div class="box">
                    <div class="section-title">ğŸ“Œ ì£¼ìš” ë©”ëª¨</div>
                    <textarea class="form-input" style="height:280px; resize:none; background:#222;" placeholder="ì´ìŠˆì‚¬í•­, ì—°ë½ì²˜, íŠ¹ì´ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <div class="grid-2">
                <div class="box">
                    <div class="section-title">ğŸ—ï¸ ì„¤ê³„ ë°ì´í„° ì…ë ¥</div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="update_space" value="true">
                        
                        <label style="color:#007acc; margin-top:10px;">ğŸ“ ê³µê°„ ì •ë³´</label>
                        <div class="grid-3">
                            <div><label>ê°€ë¡œ(m)</label>{{ space_form.venue_width }}</div>
                            <div><label>ê¹Šì´(m)</label>{{ space_form.venue_depth }}</div>
                            <div><label>ì²œê³ (m)</label>{{ space_form.venue_height }}</div>
                        </div>

                        <label style="color:#007acc; margin-top:20px;">ğŸª ë¬´ëŒ€ ì •ë³´</label>
                        <div class="grid-3">
                            <div><label>ê°€ë¡œ(m)</label>{{ space_form.stage_width }}</div>
                            <div><label>ê¹Šì´(m)</label>{{ space_form.stage_depth }}</div>
                            <div><label>ë†’ì´(m)</label>{{ space_form.stage_height }}</div>
                        </div>

                        <label style="color:#007acc; margin-top:20px;">âš™ï¸ ì˜µì…˜</label>
                        <div class="grid-2">
                            <div><label>ê°ì„ ë°°ì¹˜ íƒ€ì…</label>{{ space_form.seating_type }}</div>
                            <div><label>ê°ì„ê°„ê²©</label>{{ space_form.table_gap }}</div>
                        </div>
                        <div class="grid-2" style="margin-top:10px;">
                            <div style="padding-top:10px;">{{ space_form.has_virgin_road }} ë²„ì§„ë¡œë“œ í¬í•¨</div>
                            <div style="padding-top:10px;">{{ space_form.has_foh }} FOH í¬í•¨</div>
                        </div>
                        
                        <button type="submit" class="btn-save">ì„¤ê³„ ì‹œë®¬ë ˆì´ì…˜ (ì €ì¥)</button>
                    </form>
                </div>

                <div class="box">
                    <div class="section-title">ğŸ“Š ê³µê°„ ë¶„ì„ & ë°°ì¹˜ë„</div>
                    {% if graph_space %}
                        <img src="data:image/png;base64,{{ graph_space }}" class="graph-img">
                    {% endif %}
                    
                    <div style="background:#333; padding:15px; border-radius:5px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>ìµœëŒ€ ìˆ˜ìš© ì¸ì›</span>
                            <span class="text-safe" style="font-weight:bold;">{{ space.pax }} ëª…</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>ë°°ì¹˜ ìˆ˜ëŸ‰</span>
                            <span style="color:white;">{{ space.table_count }} Unit</span>
                        </div>
                    </div>
                    <div style="margin-top:15px;">
                        {% for info in space.infos %}
                            <div style="color:#aaa; font-size:13px;">{{ info }}</div>
                        {% endfor %}
                        {% for warn in space.warnings %}
                            <div class="text-warn" style="font-size:13px;">âš ï¸ {{ warn }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <div class="grid-2">
                <div class="box">
                    <div class="section-title">ğŸ”Š ìŒí–¥ ì»¤ë²„ë¦¬ì§€ (Audio)</div>
                    {% if graph_audio %}
                        <img src="data:image/png;base64,{{ graph_audio }}" class="graph-img">
                    {% endif %}
                    <div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <strong style="color:#00ff00;">{{ audio.type }}</strong>
                    </div>
                    <table>
                        <tr><td>ë©”ì¸</td><td>{{ audio.specs.main }}</td></tr>
                        <tr><td>ì„œë¸Œ</td><td>{{ audio.specs.sub }}</td></tr>
                        <tr><td>ë”œë ˆì´</td><td>{{ audio.specs.delay }}</td></tr>
                        <tr><td>ì„¸íŒ…ê°’</td><td class="text-yellow">{{ audio.specs.delay_setting }}</td></tr>
                    </table>
                </div>

                <div class="box">
                    <div class="section-title">ğŸ’¡ ì¡°ëª… & ì „ë ¥ (Lighting)</div>
                    {% if graph_light %}
                        <img src="data:image/png;base64,{{ graph_light }}" class="graph-img">
                    {% endif %}

                    <div style="background:#444; color:#fff; padding:10px; border-radius:5px; margin-bottom:10px; text-align:center; font-weight:bold; border: 1px solid #00ff00;">
                        {{ gen_info }}
                    </div>

                    <div style="max-height: 250px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>ID</th><th>Fixture</th><th>Addr</th><th>Watt</th></tr></thead>
                            <tbody>
                                {% for fix in light_patch %}
                                <tr>
                                    <td class="text-safe">{{ fix.id }}</td>
                                    <td>{{ fix.fixture }}</td>
                                    <td>{{ fix.addr }}</td>
                                    <td>{{ fix.watt }}W</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align:right; margin-top:10px; color:#aaa;">
                        Total Power: <span class="text-warn">{{ light_power }} kW</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab4" class="tab-content">
            <div class="grid-2">
                <div class="box">
                    <div class="section-title">ğŸ“… í”„ë¡œì íŠ¸ ì¼ì •</div>
                    <table>
                        <thead><tr><th>ë§ˆê°ì¼</th><th>D-Day</th><th>ë‚´ìš©</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>{{ task.deadline|date:"Y-m-d" }}</td>
                                <td class="text-warn">{{ task.deadline|timeuntil }}</td>
                                <td>{{ task.content }}</td>
                                <td>
                                    <form method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="delete_task" value="true">
                                        <input type="hidden" name="task_id" value="{{ task.id }}">
                                        <button type="submit" class="btn-del">ì‚­ì œ</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" style="text-align:center; padding:20px;">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="box" style="height: fit-content;">
                    <div class="section-title">â• ì¼ì • ì¶”ê°€í•˜ê¸°</div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="add_task" value="true">
                        <label>í•  ì¼ ë‚´ìš©</label>
                        {{ task_form.content }}
                        <label style="margin-top:15px;">ë§ˆê°ì¼</label>
                        {{ task_form.deadline }}
                        <button type="submit" class="btn-save">ì¼ì • ë“±ë¡</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="tab5" class="tab-content">
            <div class="box">
                <div class="section-title" style="display:flex; justify-content:space-between;">
                    <span>ğŸ“ íì‹œíŠ¸ (Cue Sheet)</span>
                    <a href="{% url 'export_excel' event.id %}" style="background-color: #217346; color: white; padding: 5px 15px; text-decoration: none; border-radius: 4px; font-size: 14px;">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #444;">
                    <table>
                        <thead style="position: sticky; top: 0; background:#2a2a2a;">
                            <tr><th width="60">No</th><th>ë‚´ìš©</th><th width="80">ì‹œê°„</th><th>BGM</th><th>Action</th></tr>
                        </thead>
                        <tbody>
                            {% for cue in cues %}
                            <tr>
                                <td class="text-safe">Q{{ cue.order }}</td>
                                <td>{{ cue.content }}</td>
                                <td>{{ cue.duration }}s</td>
                                <td>{{ cue.bgm }}</td>
                                <td><span style="background:#444; padding:2px 6px; border-radius:4px;">{{ cue.action }}</span></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" style="text-align:center; padding:30px;">íì‹œíŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div style="background:#333; padding:15px; border-radius:5px;">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="save_cue" value="true">
                        <div style="display: flex; gap: 10px;">
                            <div style="width:60px;">{{ form.order }}</div>
                            <div style="flex-grow:1;">{{ form.content }}</div>
                            <div style="width:80px;">{{ form.duration }}</div>
                            <div style="width:150px;">{{ form.bgm }}</div>
                            <div style="width:80px;">{{ form.action }}</div>
                            <button type="submit" class="btn-save" style="width:auto; margin-top:0;">ì¶”ê°€</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>